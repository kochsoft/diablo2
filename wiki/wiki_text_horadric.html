<html>
<head>
  <title>Horadric Exchange -- a Diablo II inter-Character Item Swapper</title>
<style>
  center_img {display: block; margin-left: auto; margin-right: auto}
</style>
</head>>

<body>
<figure>
  <img src="logo_horadric_exchange.png" alt="Horadric Exchange" class="center_img">
</figure>

<h1>Horadric Exchange -- a v1.10-v1.14d Diablo II inter-Character Item Swapper and Save Game Editor</h1>

<h2>Last night, at the Rogue's camp</h2>

<p>
So, your hero found the <b>sacred globe of divine intervention</b>.
</p>
<p>Sadly, the joy of it is mitigated by the fact, that the Barbarian
really has no idea what end of the thing to clobber over the head of the next
unsuspecting monster.
</p><p>
Your Sorceress has more knowledge and would make great use of the globe.
However, she is in a different save game.
</p><p>
As it stands, the Barbarian takes the priceless, shiny thing, walks up to
that Gheed character, and ... you get the picture.
</p>

<figure>
  <img src="gheed.png" alt="Gheed and Barbarian" class="center_img">
  <figcaption>Fig.1 - Gheed is a wonderful human being, and a true friend.</figcaption>
</figure>

<h2>What these two scripts are not</h2>
<p>
They are, at this point in time, not for modern versions of Diablo II, more specifically,
they probably won't work very good, if at all, beyond game versions <b>1.10-1.14d</b>.
I would not know, because I only have a legit, but antique installation running on
wine-10.1 available. However, it should be a matter of rather straight-forward
modifications of target bit sites in <code>horazons_folly.py</code> to generalize it
to other save-game versions.
</p><p>
Also, if you are looking for a fast way to finally create that 'Jah Ith Ber' rune
set or the elite three-socketed armor for it: These scripts may be misused to copy
an existing armor. However, they will not create any of these components ex nihili.
Nor are they meant to do so.
</p><p>
Inevitably though, development of the primary goal <i>(i.e., exchanging the contents of the
Horadric Cubes between two distinct character <code>.d2s</code> save-game files)</i>,
led to some generous cheating functions as well. They are available, e.g., in the
GUI from a separate Tab <b>Horazon's Folly</b>.
</p>

<h2>What these two scripts are</h2>

The project mainly comprises

<ul>
  <li><b>horazons_folly.py</b>: A technically simplistic, command line script, that may do
    all the save-game editing magic that I discovered writing the functionality of
    "Horadric Exchange". It runs on vanilla Python 3 and comes with a detailed
    <code>--help</code> text.
    Indispensable source of information was the page
    <a href="https://github.com/WalterCouto/D2CE/blob/main/d2s_File_Format.md">D2CE</a>,
    that contains a lot of knowledge for anyone endeavoring to understand Diablo II
    save-game files.
  </li>
  <li><b>horadric_exchange.py</b>: A GUI frontend for <code>horazons_folly.py</code>.
    It brings one dependency: <code>tkinter</code>, the basic, python GUI system.
    On windows it may be selected as optional during installation of the Python 3
    interpreter. Under Linux there often is a dedicated package to be had, or
    <code>python -m pip install tkinter</code> might help.
    The GUI allows to load and read save-game contents, and to do both, the title-
    giving Horadric Exchanges, and some more clandestine edits like (reversible,
    but still gain-maintaining!) godmode, or attribute or skill resets, if one
    indulges into the "Horazon's Folly Tab". There is more.
  </li>>
</ul>

<figure>
  <img src="prior_to_horadric_exchange.png" alt="The Horadric Exchange GUI tab" class="center_img">
  <figcaption>Fig.2 - The main tab allows to load two characters and to exchange
    items between them via the Horadric Cube.</figcaption>
</figure>

<figure>
  <img src="250202_moved_items.png" alt="Charonson got an item personalized to Alissa" class="center_img">
  <figcaption>Fig.3 - Charonson got an item that was personalized to Alissa. Although he will
  still need more experience to make good use of it. She will probably want to have it back
  anyways.</figcaption>
</figure>

<h2>Setup</h2>

Installation is as simple as putting both <b>.py</b> files and the two graphics,
<b>logo_horadric_exchange.png</b> and <b>potion_of_life.png</b>, into one directory
and running the desired script using a python 3 interpreter.

<b>There is no config file.</b> Instead, there is a small block "config.sys" close to the
top of <code>horardric_exchange.py</code>. That section provides two global variables
that will define
<ul>
  <li><b>pname_work:</b> Horadric Exchange does a generous amount of backups of your
  original save-games (with timestamps!), .humanity restore files (they will allow
  returning from godmode in a sensible, progress-preserving way), and even cube-content
    saves, if this function is used.
  I label these backups necessary, as they will save your characters if the scripts
  should ever leave you with corrupted files -- editing binary save-games is a
    dangerous process!
  So create some writable directory of your choosing and refer to it here.</li>
  <li><b>pname_d2:</b> The target "Save" directory within the actual game installation.</li>
</ul>

<figure>
  <img src="config_sys.png" alt="Use config.sys section in horadric_exchange.py to define default directories." class="center_img">
  <figcaption>Fig.4 - This global structure in <b>horadric_exchange.py</b> defines default
    values for the necessary backup/working directory and the location of your
    Diablo II v1.10-v1.14d Save game directory.</figcaption>
</figure>

<h2>Usage</h2>
<p>
Both, the <code>--help</code> section of <code>horazons_folly.py</code>, and the
GUI, provided by <code>horadric_exchange.py</code> are rather self-explanatory.
</p><p>
Still some comments to the GUI. The general workflow for both tabs is:
</p>
<ul>
  <li>Ensure a writable-to backup directory. The button "Work Dir" will show green,
    if all is in order. Else red. Red means you will not be able to continue until
    a proper backup directory is setup. This script will not create directories on
    its own.</li>
  <li>Load character files. In the case of Horadric Exchange, it is required that
  both characters have progressed far enough to own their own Horadric Cube.</li>
  <li>In the case of the Horazon's Folly tab, do whatever edits that seem good to you.</li>
  <li>At the bottom of each tab there is one large button. These buttons start out
  disabled, but will activate, once the above conditions are fulfilled.</li>
</ul>
<p>
Clicking on such a master button will trigger the associated process. It will do
a backup of any modified <b>.d2s</b> character file, prefixing it with a current
timestamp, suffixing it <b>.backup</b>. It will also do changes to the original
save-game, of course. These are done in-place in your Diablo II Save directory.
</p><p>
Needless to say, that <b>.humanity</b> files, that are created when entering
godmode, need to be sited in the selected backup directory to be found and used.
</p>

<figure>
  <img src="horazons_folly.png" alt="The Horazon's Folly tab." class="center_img">
  <figcaption>Fig.5 - Horazon's Folly, too, uses the backup directory selected
    in the Horadric Exchange tab. However, it acts on only one character file.</figcaption>
</figure>

<h2>Some Comments on Diablo II save-game Files.</h2>
<p>
This whole project would not exist if it were not for Walter Couto's beautiful
Diablo II save-game file format analysis page:
</p><p>
<a href=https://github.com/WalterCouto/D2CE/blob/main/d2s_File_Format.md>https://github.com/WalterCouto/D2CE/blob/main/d2s_File_Format.md</a>
</p><p>
  For the remainder of this text I will silently refer to this source.
  Yet, there are couple of grains of knowledge, that I found on my own, too.
  Note however, that, as stated above, all is promised to hold true to v1.10-v1.14d only.
</p>
<h3>Health, Mana, and Stamina Attributes</h3>
<p>
It is true, that these attributes are encoded in 21 bits. However, they are regular in being
  encoded forward. Their being hard to decipher stems from the fact, that they encode
  a rudimentary floating point schema: The most significant (little endian!) 8 bits
  encode "64" for "1/4", "128" for "2/4", and "192" for "3/4". The powers that be
  at Blizzard North, in their infinite wisdom, decided, that balancing of some
  characters like the Amazon, or, most notably, the Assassin requires quarter points.
  See, e.g., <a href="https://diablo.fandom.com/wiki/Assassin#Attributes">here, at diablo.fandom</a>.
</p><p>
  Only the least 13 bit encode the actual integer values. I guess, this will probably
  set the absolute Maxima of Mana, Life and Stamina to <b>8192.75</b> each.
</p><p>
</p>Here is an example taken using the debugging function <code>--info_stats</code> from
<b>horazons_folly.py</b>.
<p>
  <i>
  Example bit-sequence: ID, Quarters, and proper value.<br />
ID: 000001000 (AT_CURRENT_MANA), value: 8<br />
  Val: 01000000 (64) 0000000011100 (28)</i>
</p>

<p>
  I can also not confirm that any of the other values are bit-inverted.
</p><p>
The variable length of the attributes section seems to stem from the fact
  that values that are 0 are not listed, but missing. It appears that 0 values
  are even illegal.  When I tried to add explicit 0 values this led me into a
  corrupt save-game, complaining that the skill section (which is beyond attributes)
  were corrupted. Only when I made sure, that 0 values are not present all was well again.
</p><p>
The skill section is far simpler than described. It is preceded with the code
<b>if</b>. However, after that, there just come 30 byte values describing
the hard-point skill-levels for the individual skills of the character in
question. The order of skills in the skilltrees is over all trees and
horizontally, beginning by the lowest-most tab. Huh?
</p><p>
  <b>Example:</b> Consider the Necromancer. In-game press "T" to open the skills
trees. The lowest tab is "Curses", above is "Poison and Bone", and the top-most
tab is "Summoning". Take these three trees and place them side-by-side:
"Curses" left, "Poison and Bone" in the middle, and on the right "Summoning".
And now read the skills left to right, line by line. First skill is "Amplified
Damage", followed by "Teeth", "Bone Armor", "Skeleton Mastery" and "Raise Skeleton".
Next comes the second row with "Dim Vision", "Weaken", "Poison Dagger", and so on.
The other character classes' skills are organized in the same way.
</p>
</body>
</html>